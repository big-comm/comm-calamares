<!-- comm-calamares/usr/share/bigbashview/apps/calamares/desktops.html -->

<!-- Configuração do projeto -->
<script>const projectName = 'calamares-biglinux';</script> 
<?include html /usr/share/bigbashview/framework/html/genericHeader.html?>

<!-- Decorador de janela -->
<link href="/usr/share/bigbashview/framework/css/client-side-decorator.css" rel="stylesheet">
<script src="qrc:///qtwebchannel/qwebchannel.js"></script>
<script src="/usr/share/bigbashview/framework/js/client-side-decorator.js" defer></script>
<?include bash /usr/share/bigbashview/framework/shell/windowControlSide.sh 2> /dev/null ?>

<title>Select Desktop Environment</title>
<style>
  /* Estilos para manter a consistência com suas outras páginas */
  #page::before {
    content: ""; position: absolute; top: 0; left: 15; right: 15; bottom: 15;
    border-radius: 9px; background: var(--background); opacity: 0.9; z-index: -1;
  }
  #page.maximized-mode::before {
    top: 0; left: 0; right: 0; bottom: 0; border-radius: 0px;
  }
  .container { width: 100vw; height: 86vh; margin: 0 auto; display: flex; flex-direction: column; padding-top: 20px; padding-bottom: 20px; }
  .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; flex-grow: 1; overflow-y: auto; padding: 1rem;}
  .grid-item { display: flex; flex-direction: column; padding: 1rem; border-radius: 10px; }
  .grid-item-header { display: flex; align-items: center; margin-bottom: 0.5rem; }
  .actions { text-align: center; margin-top: 1rem; }
  .padding-title { margin-top: 10px; margin-bottom: 25px; }
</style>
</head>

<body>
<div id="page" class="background-transparent window-shadow background-opacity-50 drag-area">
    <p class="absolute center drag-area padding-title" tabindex="1">Escolha seu ambiente e pacotes</p>
    
    <div x-data="packageSelector('desktop-groups.sh')" class="container middle drag-area">
        <div class="grid-container drag-area">
            <template x-for="group in packageGroups" :key="group.name">
                <div class="grid-item system-background-color medium-elevate">
                    <div class="grid-item-header">
                        <label class="switch">
                            <input type="checkbox" x-model="group.selected" tabindex="1">
                            <span></span>
                        </label>
                        <h6 class="no-margin" style="margin-left: 1rem;" x-text="group.name" tabindex="1"></h6>
                    </div>
                    <p class="small" x-text="group.description" tabindex="1"></p>
                </div>
            </template>
        </div>
    
        <div class="medium-elevate no-padding large-margin">
            <article class="system-background-color no-padding no-margin">
            <nav class="padding center-align no-space drag-area">
                <button @click="window.location.href = 'index.html'" class="tertiary left absolute margin">Voltar</button>
                <button @click="submitSelection" class="tertiary right absolute margin">Continuar</button>
            </nav>
            </article>
        </div>
    </div>
</div>

<script>
    function packageSelector(url) {
        return {
            packageGroups: [],
// Dentro da função packageSelector em desktops.html
						init() {
						    // Comando Python para ler o YAML e imprimir como JSON
						    const pythonCommand = `python -c "import yaml, json, sys; print(json.dumps(yaml.safe_load(sys.stdin)))" < /usr/share/calamares/modules/desktop-groups.yaml`;
						
						    _runCmd(pythonCommand, (data) => {
						        console.log("Dados brutos recebidos do backend:", data);
						
						        try {
						            const parsedData = JSON.parse(data);
						            this.packageGroups = parsedData;
						            console.log("Dados JSON processados com sucesso:", this.packageGroups);
						        } catch (e) {
						            console.error("ERRO ao processar o JSON:", e);
						            console.error("Os dados que causaram o erro foram:", data);
						            alert("Erro ao carregar a lista de pacotes. Verifique o console para detalhes.");
						        }
						    });
						},
            submitSelection() {
                const selectedPackages = this.packageGroups
                    .filter(group => group.selected)
                    .flatMap(group => group.packages)
                    .join(' '); // Junta todos os pacotes em uma única string separada por espaços

                const form = document.createElement('form');
                form.method = 'POST';
                form.action = 'install.sh.htm';

                // Input para a lista de pacotes a instalar
                const inputPackages = document.createElement('input');
                inputPackages.type = 'hidden';
                inputPackages.name = 'install_packages';
                inputPackages.value = selectedPackages;
                form.appendChild(inputPackages);

                // Input para a opção de instalação (pode manter btrfs como padrão)
                const inputOption = document.createElement('input');
                inputOption.type = 'hidden';
                inputOption.name = 'option';
                inputOption.value = 'btrfs';
                form.appendChild(inputOption);

                // Input para marcar que é uma instalação customizada
                const inputCustom = document.createElement('input');
                inputCustom.type = 'hidden';
                inputCustom.name = 'use_custom_desktop';
                inputCustom.value = 'yes';
                form.appendChild(inputCustom);
                
                document.body.appendChild(form);
                form.submit();
            }
        };
    }
</script>
</div>
</body>
</html>
